<!doctype html>
<html>
  <head>
    <base target="_top" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@500&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        margin: 0;
        padding: 0;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #000000;
        transition: background-color 0.3s ease;
      }
      
      .container {
        width: 100%;
        max-width: 600px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
      }

      body[style*="background-image"] .container {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      body[style*="background-image"] #results-container {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      body[style*="background-image"] #results-container h3 {
        background: rgba(66, 133, 244, 0.8);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
      }

      h2 {
        text-align: center;
        color: #ffffff;
        margin-bottom: 30px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        font-family: 'Space Grotesk', sans-serif;
        font-weight: 500;
        letter-spacing: -0.5px;
      }

      body[style*="background-image"] h2 {
        color: #ffffff;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .input-container {
        position: relative;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
      }

      input {
        width: 100%;
        height: 50px;
        padding: 0 60px 0 20px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 25px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.1);
        color: #ffffff;
        font-family: 'Inter', sans-serif;
        font-weight: 400;
      }

      input::placeholder {
        color: rgba(255, 255, 255, 0.6);
      }

      input:focus {
        outline: none;
        border-color: #ffffff;
        box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
      }

      .submit-button {
        position: absolute;
        right: 5px;
        background-color: #ffffff;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
      }

      .submit-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        background-color: #f0f0f0;
      }

      .submit-button:active {
        transform: translateY(0);
        box-shadow: 0 2px 3px rgba(0, 0, 0, 0.2);
      }

      .submit-button svg {
        width: 20px;
        height: 20px;
        fill: #000000;
      }

      #results-container {
        margin-top: 30px;
        border-radius: 12px;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.95);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      #qa-rating-container {
        margin-bottom: 20px;
        padding: 15px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.95);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        display: none;
      }

      #qa-rating-container.awaiting {
        background: rgba(255, 193, 7, 0.1);
        border-left: 4px solid #ffc107;
      }

      #qa-rating-container.rated {
        background: rgba(76, 175, 80, 0.1);
        border-left: 4px solid #4caf50;
      }

      #qa-rating-container.error {
        background: rgba(244, 67, 54, 0.1);
        border-left: 4px solid #f44336;
      }

      #flag-container {
        display: none;
        margin-bottom: 20px;
        padding: 15px;
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        width: 100%;
        box-sizing: border-box;
      }

      #flag-container.active {
        display: block;
      }

      .flag-options {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .flag-option {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        flex: 1;
        min-width: 120px;
      }

      .flag-option input[type="radio"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        appearance: none;
        -webkit-appearance: none;
        border: 2px solid rgba(255, 255, 255, 0.5);
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
        margin: 0;
        padding: 0;
        position: relative;
      }

      .flag-option input[type="radio"]:checked {
        background: #4285f4;
        border-color: #4285f4;
        box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.2);
      }

      .flag-option input[type="radio"]:checked::after {
        content: '';
        position: absolute;
        width: 8px;
        height: 8px;
        background: white;
        border-radius: 50%;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      .flag-option label {
        cursor: pointer;
        color: rgba(255, 255, 255, 0.9);
        font-size: 14px;
        font-family: 'Inter', sans-serif;
        font-weight: 400;
        white-space: nowrap;
      }

      #task-id-input {
        display: none;
        margin-top: 15px;
        position: relative;
        width: 100%;
        box-sizing: border-box;
      }

      #task-id-input.active {
        display: block;
      }

      #task-id-input input {
        width: 100%;
        height: 50px;
        padding: 0 60px 0 20px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 25px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: rgba(0, 0, 0, 0.3);
        color: rgba(255, 255, 255, 0.9);
        font-family: 'Inter', sans-serif;
        font-weight: 400;
        box-sizing: border-box;
      }

      #task-id-input input::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }

      #task-id-input input:focus {
        outline: none;
        border-color: #4285f4;
        box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.2);
      }

      #task-id-submit {
        position: absolute;
        right: 5px;
        top: 5px;
        background-color: #4285f4;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
      }

      #task-id-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        background-color: #3367d6;
      }

      #task-id-submit:active {
        transform: translateY(0);
        box-shadow: 0 2px 3px rgba(0, 0, 0, 0.2);
      }

      #task-id-submit svg {
        width: 20px;
        height: 20px;
        fill: #ffffff;
      }

      #flag-submit-button {
        display: none;
      }

      .qa-rating-header {
        font-weight: 600;
        margin-bottom: 8px;
        color: #333;
      }

      .qa-rating-content {
        color: #666;
        font-size: 14px;
      }

      .qa-reasoning {
        margin-top: 8px;
        font-style: italic;
        color: #555;
      }

      #results-container h3 {
        background: transparent;
        color: #000000;
        margin: 0;
        padding: 15px 20px;
        font-size: 18px;
        font-weight: 600;
        letter-spacing: -0.3px;
        text-shadow: none;
        transition: background-color 0.3s ease, color 0.3s ease;
        font-family: 'Inter', sans-serif;
      }

      body[style*="background-image"] #results-container h3 {
        color: #ffffff;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      }

      #results-list {
        list-style-type: none;
        padding: 0;
        margin: 0;
        max-height: 400px;
        overflow-y: auto;
        background: rgba(255, 255, 255, 0.95);
      }

      #results-list::-webkit-scrollbar {
        width: 8px;
      }

      #results-list::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
      }

      #results-list::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 4px;
      }

      #results-list::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.4);
      }

      #results-list li {
        padding: 15px 20px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 16px;
        color: #333333;
        font-family: 'Inter', sans-serif;
        font-weight: 400;
      }

      #results-list li::before {
        display: none;
      }

      #results-list li:hover {
        background-color: transparent;
        transform: none;
        padding-left: 20px;
      }

      #results-list li:last-child {
        border-bottom: none;
      }

      #results-list li:first-child {
        animation: slideIn 0.3s ease;
      }

      #results-list li:nth-child(2) {
        animation: slideIn 0.4s ease;
      }

      #results-list li:nth-child(3) {
        animation: slideIn 0.5s ease;
      }

      #results-list li:nth-child(4) {
        animation: slideIn 0.6s ease;
      }

      #results-list li:nth-child(5) {
        animation: slideIn 0.7s ease;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .loading-spinner {
        display: none;
        justify-content: center;
        align-items: center;
        margin: 20px 0;
        position: relative;
        height: 60px;
      }

      .sonar {
        position: relative;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        animation: sonar 2s infinite;
      }

      .sonar::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        animation: sonar 2s infinite 0.5s;
      }

      .sonar::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        animation: sonar 2s infinite 1s;
      }

      @keyframes sonar {
        0% {
          transform: scale(0.5);
          opacity: 0.8;
        }
        100% {
          transform: scale(2);
          opacity: 0;
        }
      }

      body[style*="background-image"] .sonar,
      body[style*="background-image"] .sonar::before,
      body[style*="background-image"] .sonar::after {
        background: rgba(0, 0, 0, 0.3);
      }

      #submission-status {
        margin-top: 10px;
        text-align: center;
        color: rgba(255, 255, 255, 0.8);
        font-family: 'Inter', sans-serif;
        font-weight: 400;
      }

      .menu-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        background-color: #ffffff;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        transition: transform 0.3s ease;
      }

      .menu-button:hover {
        transform: scale(1.1);
      }

      .menu-button span {
        display: block;
        width: 6px;
        height: 6px;
        background-color: #000000;
        border-radius: 50%;
        margin: 3px 0;
        transition: all 0.3s ease;
      }

      .color-menu {
        position: fixed;
        bottom: 20px;
        right: 80px;
        display: none;
        flex-direction: row;
        gap: 10px;
        z-index: 999;
        align-items: center;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 15px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .color-menu.active {
        display: flex;
      }

      .color-option {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s ease;
        background-size: cover;
        background-position: center;
        border: 2px solid rgba(255, 255, 255, 0.3);
      }

      .color-option:hover {
        transform: scale(1.1);
        border-color: rgba(255, 255, 255, 0.8);
      }

      .color-option svg {
        width: 20px;
        height: 20px;
        stroke: #ffffff;
      }

      .custom-bg-input {
        position: fixed;
        bottom: 20px;
        right: 80px;
        display: none;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 15px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        z-index: 999;
      }

      .custom-bg-input.active {
        display: block;
      }

      .custom-bg-input .input-container {
        position: relative;
        margin: 0;
        display: flex;
        align-items: center;
      }

      .custom-bg-input input {
        width: 250px;
        height: 50px;
        padding: 0 60px 0 20px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 25px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.1);
        color: #ffffff;
      }

      .custom-bg-input input:focus {
        outline: none;
        border-color: #ffffff;
        box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
      }

      .custom-bg-input .submit-button {
        position: absolute;
        right: 5px;
        background-color: #ffffff;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s ease;
      }

      .custom-bg-input .submit-button:hover {
        transform: scale(1.1);
      }

      .custom-bg-input .submit-button svg {
        width: 20px;
        height: 20px;
        fill: #000000;
      }

      .paste-button {
        position: absolute;
        right: 50px;
        background: none;
        border: none;
        cursor: pointer;
        padding: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0.8;
        transition: all 0.3s ease;
        z-index: 2;
      }

      .paste-button:hover {
        opacity: 1;
        transform: scale(1.1);
      }

      .paste-button svg {
        width: 20px;
        height: 20px;
        fill: #ffffff;
        filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));
      }

      .paste-button:hover svg {
        fill: #ffffff;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.4));
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>FloorGPT 2.1 Beta</h2>
      <form id="queryForm">
        <div class="input-container">
          <input type="text" name="query" id="queryInput" placeholder="Enter your query here..." required autocomplete="off" />
          <button type="button" class="paste-button" onclick="pasteToInput('queryInput')">
            <svg viewBox="0 0 24 24">
              <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 16H5V5h2v2h10V5h2v14z"/>
            </svg>
          </button>
          <button type="submit" class="submit-button">
            <svg viewBox="0 0 24 24">
              <path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/>
            </svg>
          </button>
        </div>
        <div id="submission-status"></div>
      </form>

      <div id="results-container" style="display: none">
        <div id="flag-container">
          <div class="flag-options">
            <div class="flag-option">
              <input type="radio" id="flag-cca" name="flag-type" value="cca">
              <label for="flag-cca">CCA</label>
            </div>
            <div class="flag-option">
              <input type="radio" id="flag-formatting" name="flag-type" value="formatting">
              <label for="flag-formatting">Formatting Issue</label>
            </div>
          </div>
          <div id="task-id-input">
            <input type="text" id="taskIdInput" placeholder="Enter Task ID" autocomplete="off">
            <button type="button" id="task-id-submit" onclick="submitFlag()">
              <svg viewBox="0 0 24 24">
                <path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/>
              </svg>
            </button>
          </div>
        </div>
        <div id="qa-rating-container">
          <div class="qa-rating-header">QA Rating</div>
          <div class="qa-rating-content"></div>
          <div class="qa-reasoning"></div>
        </div>
        <h3>Raters</h3>
        <div class="loading-spinner" id="loadingSpinner">
          <div class="sonar"></div>
        </div>
        <ul id="results-list"></ul>
      </div>
    </div>

    <div class="menu-button" id="menuButton">
      <span></span>
      <span></span>
      <span></span>
    </div>

    <div class="color-menu" id="colorMenu">
      <div class="color-option" style="background-image: url('https://i.redd.it/cmgmwiord6le1.png');" data-bg="https://i.redd.it/cmgmwiord6le1.png"></div>
      <div class="color-option" style="background-image: url('https://i.redd.it/4ur3tny7ka3e1.png');" data-bg="https://i.redd.it/4ur3tny7ka3e1.png"></div>
      <div class="color-option" style="background-image: url('https://i.redd.it/vc0wepn305fe1.png');" data-bg="https://i.redd.it/vc0wepn305fe1.png"></div>
      <div class="color-option" style="background-image: url('https://i.redd.it/60tjwn2tsote1.jpeg');" data-bg="https://i.redd.it/60tjwn2tsote1.jpeg"></div>
      <div class="color-option" style="background-image: url('https://i.redd.it/arf5qpttdcpe1.png');" data-bg="https://i.redd.it/arf5qpttdcpe1.png"></div>
      <div class="color-option" style="background-image: url('https://i.redd.it/eeue3ankl6we1.png');" data-bg="https://i.redd.it/eeue3ankl6we1.png"></div>
      <div class="color-option" style="display: flex; align-items: center; justify-content: center;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <circle cx="8.5" cy="8.5" r="1.5"></circle>
          <polyline points="21 15 16 10 5 21"></polyline>
        </svg>
      </div>
    </div>

    <div class="custom-bg-input" id="customBgInput">
      <div class="input-container">
        <input type="text" placeholder="Enter image URL" id="bgUrlInput" autocomplete="off">
        <button type="button" class="paste-button" onclick="pasteToInput('bgUrlInput')">
          <svg viewBox="0 0 24 24">
            <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 16H5V5h2v2h10V5h2v14z"/>
          </svg>
        </button>
        <button class="submit-button" onclick="setCustomBackground()">
          <svg viewBox="0 0 24 24">
            <path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/>
          </svg>
        </button>
      </div>
    </div>

    <script>
      document
        .getElementById("queryForm")
        .addEventListener("submit", function (e) {
          e.preventDefault()
          const formData = Object.fromEntries(new FormData(e.target))
          google.script.run
            .withSuccessHandler(handleSubmissionResult)
            .withFailureHandler(handleError)
            .submitQuery(formData)
        })

      function handleSubmissionResult(result) {
        // Display QA rating if available
        const qaRatingContainer = document.getElementById('qa-rating-container');
        const qaRatingContent = qaRatingContainer.querySelector('.qa-rating-content');
        const qaReasoning = qaRatingContainer.querySelector('.qa-reasoning');
        const flagContainer = document.getElementById('flag-container');
        const taskIdInput = document.getElementById('task-id-input');
        
        if (result.qaRating) {
          // The qaRating is already parsed from the backend
          const qaRating = result.qaRating;
          
          if (qaRating.status === 'awaiting') {
            qaRatingContainer.style.display = 'none';
            flagContainer.classList.add('active');
            qaRatingContent.textContent = qaRating.message;
            qaReasoning.textContent = '';
          } else {
            qaRatingContainer.style.display = 'block';
            flagContainer.classList.remove('active');
            qaRatingContainer.className = 'qa-rating-container ' + qaRating.status;
            
            if (qaRating.status === 'rated') {
              qaRatingContent.textContent = `Rating: ${qaRating.rating}`;
              qaReasoning.textContent = qaRating.reasoning ? `Reasoning: ${qaRating.reasoning}` : '';
            } else {
              qaRatingContent.textContent = qaRating.error;
              qaReasoning.textContent = '';
            }
          }
        } else {
          qaRatingContainer.style.display = 'none';
          flagContainer.classList.remove('active');
        }
        
        performSearch(result.query);
      }

      function handleError(error) {
        console.error("Error:", error)
        document.getElementById("submission-status").textContent =
          "An error occurred: " + error
      }

      function performSearch(query) {
        const searchTerm = query || document.getElementById("queryInput").value
        if (searchTerm) {
          document.getElementById("results-container").style.display = "block"
          document.getElementById("loadingSpinner").style.display = "flex"
          document.getElementById("results-list").style.display = "none"
          
          google.script.run
            .withSuccessHandler(displaySearchResults)
            .withFailureHandler(handleError)
            .findMatchingNamesFrontend(searchTerm)
        } else {
          document.getElementById("results-container").style.display = "block"
          document.getElementById("results-list").innerHTML =
            "<li>Please enter a query to search.</li>"
        }
      }

      function displaySearchResults(matchingNamesJson) {
        const matchingNames = JSON.parse(matchingNamesJson)
        const resultsContainer = document.getElementById("results-container")
        const resultsList = document.getElementById("results-list")
        const loadingSpinner = document.getElementById("loadingSpinner")

        resultsList.innerHTML = ""
        loadingSpinner.style.display = "none"
        resultsList.style.display = "block"

        if (matchingNames.length > 0) {
          matchingNames.forEach(function (entry) {
            const listItem = document.createElement("li")
            
            // Create a container for the name and chat button
            const contentContainer = document.createElement("div")
            contentContainer.style.display = "flex"
            contentContainer.style.alignItems = "center"
            contentContainer.style.justifyContent = "space-between"
            contentContainer.style.width = "100%"
            
            // Create name text
            const nameText = document.createElement("span")
            nameText.textContent = entry.name
            contentContainer.appendChild(nameText)
            
            // Create chat button
            const chatButton = document.createElement("button")
            chatButton.innerHTML = `
              <svg viewBox="0 0 24 24" width="20" height="20" style="fill: currentColor;">
                <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
              </svg>
            `
            chatButton.style.background = "none"
            chatButton.style.border = "none"
            chatButton.style.cursor = "pointer"
            chatButton.style.padding = "8px"
            chatButton.style.borderRadius = "50%"
            chatButton.style.display = "flex"
            chatButton.style.alignItems = "center"
            chatButton.style.justifyContent = "center"
            chatButton.style.transition = "all 0.3s ease"
            chatButton.style.color = "#4285f4"
            
            chatButton.addEventListener("mouseover", () => {
              chatButton.style.backgroundColor = "rgba(66, 133, 244, 0.1)"
              chatButton.style.transform = "scale(1.1)"
            })
            
            chatButton.addEventListener("mouseout", () => {
              chatButton.style.backgroundColor = "transparent"
              chatButton.style.transform = "scale(1)"
            })
            
            chatButton.addEventListener("click", () => {
              window.open(`https://mail.google.com/chat/u/0/#chat/${entry.email}`, '_blank')
            })
            
            contentContainer.appendChild(chatButton)
            listItem.appendChild(contentContainer)
            resultsList.appendChild(listItem)
          })
        } else {
          const noResultsItem = document.createElement("li")
          noResultsItem.textContent = "No matching names found."
          noResultsItem.style.color = "#666"
          noResultsItem.style.fontStyle = "italic"
          resultsList.appendChild(noResultsItem)
        }
      }

      // Menu functionality
      const menuButton = document.getElementById('menuButton');
      const colorMenu = document.getElementById('colorMenu');
      const customBgInput = document.getElementById('customBgInput');
      let isMenuOpen = false;

      menuButton.addEventListener('click', () => {
        isMenuOpen = !isMenuOpen;
        colorMenu.classList.toggle('active', isMenuOpen);
        customBgInput.classList.remove('active');
      });

      // Color options functionality
      document.querySelectorAll('.color-option').forEach(option => {
        option.addEventListener('click', (e) => {
          if (option.querySelector('svg')) {
            // If it's the last option (custom background)
            customBgInput.classList.toggle('active');
            colorMenu.classList.remove('active');
          } else {
            const bgUrl = option.getAttribute('data-bg');
            setBackgroundImage(bgUrl);
            customBgInput.classList.remove('active');
            colorMenu.classList.remove('active');
            isMenuOpen = false;
          }
        });
      });

      function getImageBrightness(img) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 100; // Sample a smaller size for performance
        canvas.height = 100;
        ctx.drawImage(img, 0, 0, 100, 100);
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        let brightness = 0;
        let sampleCount = 0;
        
        // Sample every 4th pixel for better performance
        for (let i = 0; i < data.length; i += 16) {
          // Calculate perceived brightness using the formula:
          // (0.299 * R + 0.587 * G + 0.114 * B)
          const r = data[i];
          const g = data[i + 1];
          const b = data[i + 2];
          brightness += (0.299 * r + 0.587 * g + 0.114 * b);
          sampleCount++;
        }
        
        return brightness / sampleCount;
      }

      function getProminentColor(img) {
        try {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = 100;
          canvas.height = 100;
          ctx.drawImage(img, 0, 0, 100, 100);
          
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = imageData.data;
          
          // Create a color frequency map
          const colorMap = new Map();
          
          // Sample every 4th pixel
          for (let i = 0; i < data.length; i += 16) {
            const r = data[i];
            const g = data[i + 1];
            const b = data[i + 2];
            
            // Convert to hex
            const hex = `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
            
            // Count frequency
            colorMap.set(hex, (colorMap.get(hex) || 0) + 1);
          }
          
          // Find the most frequent color
          let maxCount = 0;
          let prominentColor = '#ffffff'; // Default color
          
          colorMap.forEach((count, color) => {
            if (count > maxCount) {
              maxCount = count;
              prominentColor = color;
            }
          });
          
          return prominentColor;
        } catch (error) {
          console.log('Could not extract color from image:', error);
          return '#ffffff'; // Return white as fallback
        }
      }

      function getTextColorForBackground(backgroundColor) {
        // Convert hex to RGB
        const r = parseInt(backgroundColor.slice(1, 3), 16);
        const g = parseInt(backgroundColor.slice(3, 5), 16);
        const b = parseInt(backgroundColor.slice(5, 7), 16);
        
        // Calculate perceived brightness
        const brightness = (0.299 * r + 0.587 * g + 0.114 * b);
        
        // Return black or white based on brightness
        return brightness > 128 ? '#000000' : '#ffffff';
      }

      function updateTextColors(brightness, prominentColor) {
        // Adjust the threshold based on testing (0-255 scale)
        const isLight = brightness > 150; // Higher threshold for better contrast
        
        const textColor = isLight ? '#000000' : '#ffffff';
        const containerBg = isLight ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.1)';
        const inputBg = isLight ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.1)';
        const inputBorder = isLight ? 'rgba(0, 0, 0, 0.2)' : 'rgba(255, 255, 255, 0.2)';
        const buttonBg = isLight ? '#000000' : '#ffffff';
        const buttonIcon = isLight ? '#ffffff' : '#000000';
        const pasteIconColor = isLight ? '#000000' : '#ffffff';
        
        // Update text colors
        document.querySelectorAll('h2, input, #results-list li, #results-container h3, #submission-status').forEach(el => {
          el.style.color = textColor;
        });

        // Update container backgrounds
        document.querySelectorAll('.container, #results-container, .color-menu, .custom-bg-input').forEach(el => {
          el.style.background = containerBg;
        });

        // Update input styles
        document.querySelectorAll('input').forEach(el => {
          el.style.background = inputBg;
          el.style.borderColor = inputBorder;
          el.style.color = textColor;
        });

        // Update button colors
        document.querySelectorAll('.submit-button').forEach(el => {
          el.style.backgroundColor = buttonBg;
        });

        document.querySelectorAll('.submit-button svg').forEach(el => {
          el.style.fill = buttonIcon;
        });

        // Update menu button
        const menuButton = document.querySelector('.menu-button');
        menuButton.style.backgroundColor = buttonBg;
        menuButton.querySelectorAll('span').forEach(span => {
          span.style.backgroundColor = buttonIcon;
        });

        // Update scrollbar colors
        const scrollbarThumb = isLight ? 'rgba(0, 0, 0, 0.3)' : 'rgba(255, 255, 255, 0.3)';
        const scrollbarTrack = isLight ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.1)';
        
        document.querySelectorAll('#results-list').forEach(el => {
          el.style.setProperty('--scrollbar-thumb', scrollbarThumb);
          el.style.setProperty('--scrollbar-track', scrollbarTrack);
        });

        // Update paste button icon
        document.querySelectorAll('.paste-button svg').forEach(el => {
          el.style.fill = pasteIconColor;
          el.style.filter = isLight ? 'drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3))' : 'drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3))';
        });

        // Update results container styles
        document.querySelectorAll('#results-container').forEach(el => {
          el.style.background = 'rgba(255, 255, 255, 0.95)';
        });

        document.querySelectorAll('#results-list').forEach(el => {
          el.style.background = 'rgba(255, 255, 255, 0.95)';
        });

        document.querySelectorAll('#results-list li').forEach(el => {
          el.style.color = '#333333';
          el.style.borderBottom = '1px solid rgba(0, 0, 0, 0.1)';
        });

        document.querySelectorAll('#results-list li::before').forEach(el => {
          el.style.backgroundColor = '#333333';
        });

        // Update header background with the prominent color or fallback color
        const headerBgColor = prominentColor === '#ffffff' ? '#e8f0fe' : prominentColor;
        const headerTextColor = headerBgColor === '#e8f0fe' ? '#000000' : getTextColorForBackground(headerBgColor);
        
        document.querySelectorAll('#results-container h3').forEach(el => {
          el.style.backgroundColor = headerBgColor;
          el.style.color = headerTextColor;
          el.style.textShadow = headerTextColor === '#ffffff' ? '0 1px 2px rgba(0, 0, 0, 0.3)' : 'none';
        });

        // Update heading color based on background
        const heading = document.querySelector('h2');
        if (document.body.style.backgroundImage) {
          heading.style.color = '#ffffff';
          heading.style.textShadow = '0 2px 4px rgba(0, 0, 0, 0.2)';
        } else {
          heading.style.color = '#ffffff';
          heading.style.textShadow = '0 2px 4px rgba(0, 0, 0, 0.2)';
        }
      }

      function setBackgroundImage(url) {
        if (url) {
          document.body.style.backgroundImage = `url('${url}')`;
          document.body.style.backgroundSize = 'cover';
          document.body.style.backgroundPosition = 'center';
          document.body.style.backgroundRepeat = 'no-repeat';
          
          // Create a temporary image to analyze brightness and color
          const img = new Image();
          
          // Try to load the image with CORS
          img.crossOrigin = "Anonymous";
          
          // Set up error handling
          img.onerror = function() {
            console.log('Error loading image for color extraction');
            updateTextColors(0, '#e8f0fe');
          };
          
          // Try to load the image
          try {
            img.src = url;
            
            // If the image loads successfully, try to extract colors
            img.onload = function() {
              try {
                const brightness = getImageBrightness(img);
                const prominentColor = getProminentColor(img);
                updateTextColors(brightness, prominentColor);
              } catch (error) {
                console.log('Error processing image:', error);
                updateTextColors(0, '#e8f0fe');
              }
            };
          } catch (error) {
            console.log('Error setting image source:', error);
            updateTextColors(0, '#e8f0fe');
          }
        }
      }

      function setCustomBackground() {
        const url = document.getElementById('bgUrlInput').value;
        if (url) {
          setBackgroundImage(url);
          customBgInput.classList.remove('active');
          colorMenu.classList.remove('active');
          isMenuOpen = false;
        }
      }

      // Close menus when clicking outside
      document.addEventListener('click', (e) => {
        if (!menuButton.contains(e.target) && !colorMenu.contains(e.target) && !customBgInput.contains(e.target)) {
          colorMenu.classList.remove('active');
          customBgInput.classList.remove('active');
          isMenuOpen = false;
        }
      });

      async function pasteToInput(inputId) {
        try {
          const text = await navigator.clipboard.readText();
          document.getElementById(inputId).value = text;
        } catch (err) {
          console.error('Failed to read clipboard contents: ', err);
        }
      }

      // Add flag handling functionality
      document.querySelectorAll('input[name="flag-type"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          const taskIdInput = document.getElementById('task-id-input');
          const flagSubmitButton = document.getElementById('flag-submit-button');
          
          if (e.target.checked) {
            taskIdInput.classList.add('active');
            flagSubmitButton.classList.add('active');
          }
        });
      });

      function submitFlag() {
        const selectedFlag = document.querySelector('input[name="flag-type"]:checked');
        const taskId = document.getElementById('taskIdInput').value;
        const query = document.getElementById('queryInput').value;
        
        if (selectedFlag && taskId) {
          google.script.run
            .withSuccessHandler(() => {
              // Hide flag container and show QA rating container
              document.getElementById('flag-container').classList.remove('active');
              document.getElementById('qa-rating-container').style.display = 'block';
              
              // Reset form
              document.querySelector('input[name="flag-type"]:checked').checked = false;
              document.getElementById('taskIdInput').value = '';
              document.getElementById('task-id-input').classList.remove('active');
              document.getElementById('flag-submit-button').classList.remove('active');
            })
            .withFailureHandler(handleError)
            .flagTask({
              targetSentence: query,
              taskId: taskId,
              flag: selectedFlag.value
            });
        }
      }

      document.getElementById('flag-submit-button').addEventListener('click', submitFlag);
    </script>
  </body>
</html>